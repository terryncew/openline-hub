<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>OpenLine Hub · Portable Proof for AI</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="dark light">
<style>
  :root{
    --bg:#0a0c10; --ink:#e7ecf4; --muted:#97a3b6; --line:#1b2230; --tile:#0f141c;
    --ok:#1ea672; --warn:#b38b10; --bad:#d23d3d; --chip:#121925; --chipline:#1b2536;
    --btn:#1e293b; --btnink:#e7ecf4; --btnline:#2a3a55;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 -apple-system,system-ui,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:980px;margin:0 auto;padding:18px}
  header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:12px}
  header h1{font-size:20px;margin:2px 0 0}
  .sub{color:var(--muted);font-size:13px}
  .section{margin:18px 0}
  h2{font-size:16px;margin:0 0 8px}
  .hero{background:var(--tile);border:1px solid var(--line);padding:14px;border-radius:12px}
  .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid var(--btnline);background:var(--btn);color:var(--btnink);font-weight:600}
  .btn.secondary{opacity:.9}
  .tile{background:var(--tile);border:1px solid var(--line);border-radius:12px;padding:12px}
  .card{border:1px solid var(--line);border-radius:10px;margin-top:10px;overflow:hidden}
  .row{display:flex;gap:14px;border-top:1px solid var(--line)}
  .row:first-child{border-top:0}
  .left{min-width:120px;padding:10px 14px;color:var(--muted);font-weight:600}
  .right{flex:1;padding:10px 14px}
  /* fixed pills */
  .chip{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--chipline);background:var(--chip);padding:6px 10px;border-radius:999px;font-size:12px;line-height:1;height:26px}
  .ok{background:rgba(30,166,114,.15);border-color:rgba(30,166,114,.35)}
  .warn{background:rgba(179,139,16,.15);border-color:rgba(179,139,16,.35)}
  .bad{background:rgba(210,61,61,.15);border-color:rgba(210,61,61,.35)}
  .neutral{opacity:.8}
  .note{color:var(--muted);font-size:12px;margin:8px 2px}
  textarea,input{width:100%;background:var(--tile);border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:10px}
  textarea{min-height:84px;resize:vertical}
  pre{white-space:pre-wrap;background:var(--tile);border:1px solid var(--line);padding:10px;border-radius:10px}
  @media (max-width:560px){ .left{min-width:96px} }
</style>
</head>
<body>
<div class="wrap">

  <header>
    <div>
      <h1>OpenLine Hub</h1>
      <div class="sub">Portable proof · vendor-neutral</div>
    </div>
  </header>

  <div class="section hero">
    <div style="font-size:18px;font-weight:700;margin-bottom:8px">Proof moves; data doesn’t.</div>
    <div class="sub">One viewer for OLR/1.5-P & 1.4L. Paste any receipt or URL to validate. Triage, not truth.</div>
    <div class="inline" style="margin-top:10px">
      <a class="btn" href="https://doi.org/10.5281/zenodo.17476985" target="_blank" rel="noopener">Coherence Dynamics v1.2 (Erratum)</a>
      <a class="btn secondary" href="exclusive.html">Exclusive offer</a>
    </div>
  </div>

  <div class="section">
    <h2>Featured receipts</h2>
    <div id="feat1"></div>
    <div id="feat2" style="margin-top:12px"></div>
    <div id="feat3" style="margin-top:12px"></div>
  </div>

  <div class="section">
    <h2 id="localTitle">Local receipts</h2>
    <div class="note">Add JSON to <code>docs/receipts/</code> (or <code>receipts/</code>) and list them in <code>manifest.json</code>.</div>
    <div id="local"></div>
  </div>

  <div class="section" id="exclusive">
    <h2>Demo partner offer</h2>
    <div class="tile">
      <p style="margin:0 0 6px">For teams who want a 2–3 week hands-on: ship agents with portable receipts and a simple PASS/AMBER/RED dial.</p>
      <ul style="margin:0 0 6px 18px">
        <li>Drop-in receipts (sub-KB target), no prompts/PII.</li>
        <li>Guard dials: κ (stress), Δhol (drift), Φ* star score.</li>
        <li>Offline verify; URL or pasted JSON.</li>
      </ul>
      <div class="note">Outcome: quick triage signal you can show to SRE, Sec, and Legal without exposing content.</div>
    </div>
  </div>

  <div class="section" id="exclusive">
    <h2>Researcher kit</h2>
    <div class="tile">
      <div class="note">Validate any receipt URL (raw GitHub works) <em>or paste JSON</em>. “blob” links auto-rewrite to raw.</div>
      <textarea id="valUrl" placeholder="Paste a receipt URL or the JSON itself…"></textarea>
      <div class="inline" style="margin-top:10px">
        <a class="btn" id="valBtn" href="#">Validate</a>
        <a class="btn secondary" id="copyTpl" href="#">Copy Template</a>
      </div>
      <pre id="valOut" style="margin-top:10px">Waiting…</pre>
    </div>
  </div>

  <div class="section">
    <div class="sub">OpenLine · COLE · MIT. © 2025 OpenLine Project.</div>
  </div>
</div>

<script>
/* helpers */
const el=(t,c,txt)=>{const e=document.createElement(t); if(c) e.className=c; if(txt!=null) e.textContent=txt; return e;};
const byteLen = s => new TextEncoder().encode(s).length;
function toRaw(u){
  try{
    const url = new URL(u.trim());
    if (url.hostname === 'github.com') {
      const p = url.pathname.split('/').filter(Boolean);
      if (p[2] === 'blob') return `https://raw.githubusercontent.com/${p[0]}/${p[1]}/${p[3]}/${p.slice(4).join('/')}`;
    }
    return u;
  }catch{ return u; }
}
function stars(phi){
  if(typeof phi!=='number' || !isFinite(phi)) return '';
  const s = phi>=0.92?5:phi>=0.84?4:phi>=0.76?3:phi>=0.68?2:1;
  return ` (${s}★)`;
}

/* normalizer */
function normalize(r){
  const v = r.version || r.receipt_version || r.receiptVersion || r.sku || '—';
  const status = (r.attrs?.status || r.status || '').toString();
  const model = r.model?.family || r.model?.name || r.model?.id || r.model || '—';
  const issued = r.issued_at || r.issued || r.run?.ts || r.time || r.date || '—';
  const prec = (() => {
    const tr = r.precision?.train_dtype || r.precision?.train || r.train_dtype || r.train;
    const inf = r.precision?.infer_dtype || r.precision?.infer || r.infer_dtype || r.infer;
    if (tr || inf) return `${(tr||'—')}/${(inf||'—')}`;
    return r.precision || '—';
  })();
  const claims = r.claims || r;
  const point   = claims.point   ?? '—';
  const because = claims.because ?? '—';
  const but     = claims.but     ?? '—';
  const so      = claims.so      ?? '—';

  const kappa = r.signals?.kappa ?? r.kappa ?? r.κ ?? r.dials?.kappa ?? r.telem?.kappa_eff ?? '—';
  const dhol  = r.signals?.dhol  ?? r.signals?.delta_hol ?? r.delta_hol ?? r.Δhol ?? r.dials?.delta_hol ?? r.telem?.delta_hol ?? '—';
  const phi   = r.signals?.phi_star ?? r.signals?.phi ?? r.phi_star ?? r.telem?.phi_topo ?? '—';

  return {version:v, status, model, issued, prec, point, because, but, so, dials:{'κ':kappa, 'Δhol':dhol, 'Φ*':phi}};
}

/* policy check */
function check(r, bytes){
  const errs = [];
  const version = r.version || r.receipt_version || r.receiptVersion;
  const status  = (r.attrs?.status || r.status || '').toLowerCase();
  if (!version) errs.push('missing receipt_version/version');
  if (!status)  errs.push('missing attrs.status/status');
  const cleanish = ['clean','coherent','ok','green'].includes(status);
  const warnish  = ['amber','warn','check','red','risk','bad'].includes(status);
  if (cleanish && bytes > 640) errs.push(`CLEAN exceeds 640B (${bytes})`);
  if (warnish  && bytes > 800) errs.push(`${status} exceeds 800B (${bytes})`);
  return {ok: errs.length===0, errs, version: version||'—', status: status||'—', bytes};
}

/* renderer */
function renderUniformTile(title, srcUrl, rec, bytes){
  const n = normalize(rec);
  const t = el('div','tile');

  const head = el('div','inline'); head.style.justifyContent='space-between'; head.style.alignItems='center';
  head.appendChild(el('div','', title));
  const pills = el('div'); pills.style.display='flex'; pills.style.gap='8px';
  const statusClass = n.status.match(/clean|ok|green/i)?'ok':n.status.match(/warn|amber|check/i)?'warn':n.status.match(/red|risk|bad/i)?'bad':'neutral';
  pills.appendChild(el('span','chip '+statusClass, n.status || '—'));
  pills.appendChild(el('span','chip neutral', n.version));
  head.appendChild(pills);

  const card = el('div','card');
  const row=(k,v)=>{const r=el('div','row'); r.appendChild(el('div','left',k)); r.appendChild(el('div','right',v||'—')); return r;};
  card.appendChild(row('MODEL',n.model));
  card.appendChild(row('ISSUED',n.issued));
  card.appendChild(row('PRECISION',n.prec));
  card.appendChild(row('POINT',n.point));
  card.appendChild(row('BECAUSE',n.because));
  card.appendChild(row('BUT',n.but));
  card.appendChild(row('SO',n.so));

  const dialRow = el('div','inline'); dialRow.style.gap='8px'; dialRow.style.margin='10px 14px';
  for (const [k,v] of Object.entries(n.dials)){
    const isNum = typeof v==='number' && isFinite(v);
    const val = isNum ? (k==='Φ*'?v.toFixed(3)+stars(v):v.toFixed(3)) : v;
    const chip = el('span','chip neutral', `${k} — ${val}`);
    if(k==='Φ*' && isNum){ chip.title='Φ* star bands: 5★≥0.92, 4★≥0.84, 3★≥0.76, 2★≥0.68, else 1★'; }
    dialRow.appendChild(chip);
  }
  card.appendChild(dialRow);

  const footer = el('div','note', `source: ${srcUrl} · bytes=${bytes}`);

  const btns = el('div','inline'); btns.style.marginTop='8px';
  const copyUrl = el('a','btn secondary','Copy URL'); copyUrl.href='#';
  copyUrl.onclick = (e)=>{e.preventDefault(); navigator.clipboard.writeText(srcUrl);};
  const copyJson = el('a','btn secondary','Copy JSON'); copyJson.href='#';
  copyJson.onclick = (e)=>{e.preventDefault(); navigator.clipboard.writeText(JSON.stringify(rec,null,2));};
  btns.appendChild(copyUrl); btns.appendChild(copyJson);

  t.appendChild(head); t.appendChild(card); t.appendChild(footer); t.appendChild(btns);
  return t;
}

/* loaders */
async function loadFeatured(id, url, title){
  const grid = document.getElementById(id); if (!grid) return;
  try{
    const raw = toRaw(url) + (url.includes('?')?'&':'?') + 'v=' + Date.now(); // CDN-bust
    const res = await fetch(raw, {cache:'no-store'});
    const txt = await res.text();
    const bytes = byteLen(txt);
    const j = JSON.parse(txt);
    grid.appendChild(renderUniformTile(title, raw, j, bytes));
  }catch(e){
    const tile = el('div','tile'); tile.appendChild(el('div','note',`Failed to load ${title}: ${e.message||'error'}`)); grid.appendChild(tile);
  }
}
async function fetchFirst(list){
  for (const p of list){
    try{
      const res = await fetch(p + (p.includes('?')?'&':'?') + 'v=' + Date.now(), {cache:'no-store'});
      if (res.ok) return {path:p, data: await res.json()};
    }catch{}
  }
  return null;
}
async function loadLocal(){
  const target = document.getElementById('local');
  const title  = document.getElementById('localTitle');
  const got = await fetchFirst(['docs/receipts/manifest.json','receipts/manifest.json']);
  if (!got){ target.appendChild(el('div','tile', 'No local manifest found.')); return; }
  title.textContent = `Local receipts (from ${got.path})`;
  const list = Array.isArray(got.data) ? got.data : (got.data.files || got.data.receipts || got.data.items || []);
  for (const file of list){
    try{
      const res = await fetch(file + (file.includes('?')?'&':'?') + 'v=' + Date.now(), {cache:'no-store'});
      const txt = await res.text(); const bytes = byteLen(txt); const j = JSON.parse(txt);
      target.appendChild(renderUniformTile(file.split('/').slice(-1)[0], file, j, bytes));
      const spacer = el('div'); spacer.style.height='12px'; target.appendChild(spacer);
    }catch(e){
      const t = el('div','tile'); t.appendChild(el('div','note',`Failed to load ${file}: ${e.message||'error'}`)); target.appendChild(t);
    }
  }
}

/* validator */
document.getElementById('valBtn').addEventListener('click', async (ev)=>{
  ev.preventDefault();
  const box = document.getElementById('valUrl');
  const out = document.getElementById('valOut');
  let input = (box.value||'').trim();
  if (!input) { out.textContent='Provide a URL or paste a JSON receipt.'; return; }
  try{
    let j, bytes;
    if (input.startsWith('{')) { j = JSON.parse(input); bytes = byteLen(JSON.stringify(j)); }
    else {
      const raw = toRaw(input) + (input.includes('?')?'&':'?') + 'v=' + Date.now();
      const res = await fetch(raw, {cache:'no-store'});
      if (!res.ok) throw new Error(`fetch failed (${res.status})`);
      const txt = await res.text(); bytes = byteLen(txt); j = JSON.parse(txt);
    }
    const result = check(j, bytes);
    const sigs = j.signals ? Object.entries(j.signals).map(([k,v])=>`${k}=${(typeof v==='number')?Number(v).toFixed(3):v}`).join(', ') : '—';
    const cap = (result.status==='green'||result.status==='clean'||result.status==='ok') ? 640 : 800;
    const why = `Why PASS matters: under size cap (≤${cap}B), required fields present, status recognized, signals parseable for κ/Δhol/Φ*.`;
    out.textContent = result.ok
      ? `✅ PASS\nbytes=${result.bytes} (≤${cap}) · status=${result.status} · version=${result.version}\nSignals: ${sigs}\n${why}`
      : `❌ FAIL\n- ${result.errs.join('\n- ')}`;
  }catch(e){
    out.textContent = `❌ ${e.message || 'fetch/parse failed'}`;
  }
});

/* boot */
loadFeatured('feat1','https://github.com/terryncew/COLE-Coherence-Layer-Engine-/blob/main/docs/receipt.latest.json','COLE-Coherence-Layer-Engine / receipt.latest.json');
loadFeatured('feat2','https://github.com/terryncew/open-receipts/blob/main/docs/receipt.latest.json','open-receipts / receipt.latest.json');
loadFeatured('feat3','https://github.com/terryncew/openline-csm/blob/main/docs/receipt.latest.json','openline-csm / receipt.latest.json');
loadLocal();
</script>
</body>
</html>
