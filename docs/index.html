<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>OpenLine Hub · Portable Proof for AI</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="dark light">
<style>
  :root{
    --bg:#0a0c10; --ink:#e7ecf4; --muted:#97a3b6; --line:#1b2230; --tile:#0f141c;
    --ok:#1ea672; --warn:#b38b10; --bad:#d23d3d; --chip:#121925; --chipline:#1b2536;
    --btn:#1e293b; --btnink:#e7ecf4; --btnline:#2a3a55;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 -apple-system,system-ui,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:980px;margin:0 auto;padding:18px}
  header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:12px}
  header h1{font-size:20px;margin:2px 0 0}
  .sub{color:var(--muted);font-size:13px}
  .section{margin:18px 0}
  h2{font-size:16px;margin:0 0 8px}
  .hero{background:var(--tile);border:1px solid var(--line);padding:14px;border-radius:12px}
  .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid var(--btnline);background:var(--btn);color:var(--btnink);font-weight:600}
  .btn.secondary{opacity:.9}
  .tile{background:var(--tile);border:1px solid var(--line);border-radius:12px;padding:12px}
  .card{border:1px solid var(--line);border-radius:10px;margin-top:10px;overflow:hidden}
  .row{display:flex;gap:14px;border-top:1px solid var(--line)}
  .row:first-child{border-top:0}
  .left{min-width:120px;padding:10px 14px;color:var(--muted);font-weight:600}
  .right{flex:1;padding:10px 14px}
  .chip{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--chipline);background:var(--chip);padding:6px 10px;border-radius:999px;font-size:12px;line-height:1;height:26px}
  .ok{background:rgba(30,166,114,.15);border-color:rgba(30,166,114,.35)}
  .warn{background:rgba(179,139,16,.15);border-color:rgba(179,139,16,.35)}
  .bad{background:rgba(210,61,61,.15);border-color:rgba(210,61,61,.35)}
  .neutral{opacity:.8}
  .note{color:var(--muted);font-size:12px;margin:8px 2px}
  textarea,input{width:100%;background:var(--tile);border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:10px}
  textarea{min-height:84px;resize:vertical}
  pre{white-space:pre-wrap;background:var(--tile);border:1px solid var(--line);padding:10px;border-radius:10px}
  select{background:var(--tile);border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:8px 10px}
  details summary{cursor:pointer}
  @media (max-width:560px){ .left{min-width:96px} }
</style>
</head>
<body>
<div class="wrap">

  <header>
    <div>
      <h1>OpenLine Hub</h1>
      <div class="sub">Portable proof · vendor-neutral</div>
    </div>
    <div class="inline">
      <a class="btn" href="exclusive.html">Exclusive offers</a>
    </div>
  </header>

  <div class="section hero">
    <div style="font-size:18px;font-weight:700;margin-bottom:8px">Proof moves; data doesn’t.</div>
    <div class="sub">Uniform viewer for OLR/1.5-P & 1.4L. One-click validator accepts a URL or pasted JSON. Triage, not truth.</div>
    <div class="inline" style="margin-top:10px">
      <a class="btn" href="https://doi.org/10.5281/zenodo.17476985" target="_blank" rel="noopener">Coherence Dynamics v1.2 (Erratum)</a>
    </div>
  </div>

  <div class="section">
    <h2>Featured receipts</h2>
    <div id="feat1"></div>
    <div id="feat2" style="margin-top:12px"></div>
    <div id="feat3" style="margin-top:12px"></div>
  </div>

  <div class="section">
    <h2>What the dials mean</h2>
    <div class="tile">
      <ul style="margin:0 0 6px 18px">
        <li><b>κ (kappa)</b>: stress/curvature of the run. Lower is calmer. Target ≤ <code>.75</code>.</li>
        <li><b>Δhol</b>: drift from expected behavior. Lower is steadier. Target ≤ <code>.35</code>.</li>
        <li><b>Φ*</b>: composite coherence (0–1), rendered with 0–5★ for quick reads.</li>
      </ul>
      <div class="note">Use these as guard rails: Brake / Split / Go. Then verify.</div>
    </div>
  </div>

  <div class="section" id="research">
    <h2>Researcher kit</h2>
    <div class="tile">
      <div class="note">Validate any receipt URL (raw GitHub works) <em>or paste JSON</em>. “blob” links auto-rewrite to raw.</div>
      <textarea id="valUrl" placeholder="Paste a receipt URL or JSON…"></textarea>
      <div class="inline" style="margin-top:10px">
        <a class="btn" id="valBtn" href="#">Validate</a>
        <a class="btn secondary" id="copyTpl" href="#">Copy Template</a>
        <a class="btn secondary" id="addToWalletBtn" href="#" style="display:none">Add last PASS to Wallet</a>
      </div>
      <pre id="valOut" style="margin-top:10px">Waiting…</pre>
      <div class="note" id="whyPass" style="display:none">
        PASS = (1) within cap (≤640 B green, ≤800 B amber/red), (2) core fields present, (3) guard dials present (κ, Δhol, Φ*).
      </div>
    </div>
  </div>

  <div class="section" id="wallet">
    <h2>Wallet (local packs)</h2>
    <div class="tile">
      <div class="note">Everything here lives in this browser (localStorage). No server, no tracking.</div>

      <div class="inline" style="gap:8px;margin:8px 0">
        <select id="packSel"></select>
        <a class="btn secondary" id="newPackBtn" href="#">New pack</a>
        <a class="btn secondary" id="exportPackBtn" href="#">Copy pack JSON</a>
        <a class="btn secondary" id="clearPackBtn" href="#">Clear pack</a>
      </div>

      <div class="inline" style="gap:8px;margin-bottom:8px">
        <input id="addUrl" placeholder="Add by URL (raw GitHub best)"/>
        <a class="btn" id="addUrlBtn" href="#">Add</a>
        <a class="btn secondary" id="importFeaturedBtn" href="#">Import Featured → Wallet</a>
        <a class="btn secondary" id="importLocalBtn" href="#">Import Local Manifest → Wallet</a>
        <a class="btn secondary" id="seedDemoBtn" href="#">Re-seed Demo</a>
      </div>

      <details style="margin-bottom:8px">
        <summary class="sub">Dashboard (pack triage)</summary>
        <div id="packDash" class="tile" style="margin-top:8px"></div>
      </details>

      <div id="packStats" class="note">—</div>
      <div id="packList"></div>
    </div>
  </div>

  <div class="section">
    <h2 id="localTitle">Local receipts</h2>
    <div class="note">Reads <code>docs/receipts/manifest.json</code>. Each entry is a JSON URL (relative or absolute).</div>
    <div id="local"></div>
  </div>

  <div class="section">
    <div class="sub">OpenLine · COLE · MIT.</div>
  </div>
</div>

<script>
/* ================= helpers ================= */
const el=(t,c,txt)=>{const e=document.createElement(t); if(c) e.className=c; if(txt!=null) e.textContent=txt; return e;};
const byteLen = s => new TextEncoder().encode(s).length;
const clamp01 = v => Math.max(0, Math.min(1, v));
const STATUS_GREEN = s => /^(green|clean|ok)$/i.test((s||'').trim());
function toRaw(u){
  try{
    const url = new URL(u.trim());
    if (url.hostname === 'github.com') {
      const p = url.pathname.split('/').filter(Boolean);
      if (p[2] === 'blob') return `https://raw.githubusercontent.com/${p[0]}/${p[1]}/${p[3]}/${p.slice(4).join('/')}`;
    }
    return u;
  }catch{ return u; }
}

/* Fallback sample so the demo never shows blank */
const SAMPLE_JSON = {
  "receipt_version":"1.5-P","version":"OLR/1.5-P","issued_at":"2025-11-03T00:00:00Z",
  "attrs":{"status":"CLEAN"},
  "model":{"family":"demo-llm"},
  "precision":{"train_dtype":"fp16","infer_dtype":"fp16"},
  "point":"Validated receipt path and caps.",
  "because":"Manifest and sample are reachable.",
  "but":"External sources can change.",
  "so":"Ship with local sample + external fallbacks.",
  "signals":{"kappa":0.20,"dhol":0.05,"phi_star":0.90}
};

/* ================= normalizer/check ================= */
function normalize(r){
  const v = r.version || r.receipt_version || r.receiptVersion || r.sku || '—';
  const status = (r.attrs?.status || r.status || '').toString();
  const model = r.model?.family || r.model?.name || r.model?.id || r.model || '—';
  const issued = r.issued_at || r.issued || r.run?.ts || r.time || r.date || '—';
  const prec = (() => {
    const tr = r.precision?.train_dtype || r.precision?.train || r.train_dtype || r.train;
    const inf = r.precision?.infer_dtype || r.precision?.infer || r.infer_dtype || r.infer;
    if (tr || inf) return `${(tr||'—')}/${(inf||'—')}`;
    return r.precision || '—';
  })();
  const claims = r.claims || r;
  const point   = claims.point   ?? '—';
  const because = claims.because ?? '—';
  const but     = claims.but     ?? '—';
  const so      = claims.so      ?? '—';

  const kappa = r.signals?.kappa ?? r.kappa ?? r.κ ?? r.dials?.kappa ?? r.telem?.kappa_eff ?? null;
  const dhol  = r.signals?.dhol  ?? r.signals?.delta_hol ?? r.delta_hol ?? r.Δhol ?? r.dials?.delta_hol ?? r.telem?.delta_hol ?? null;
  const phi   = r.signals?.phi_star ?? r.phi_star ?? r.dials?.phi_star ?? null;

  return {version:v, status, model, issued, prec, point, because, but, so, dials:{kappa, dhol, phi}};
}
function check(r, bytes){
  const errs = [];
  const version = r.version || r.receipt_version || r.receiptVersion;
  const status  = (r.attrs?.status || r.status || '').toLowerCase();
  if (!version) errs.push('missing receipt_version/version');
  if (!status)  errs.push('missing attrs.status/status');
  const cleanish = /^(clean|coherent|ok|green)$/i.test(status);
  const warnish  = /^(amber|warn|check|red|risk|bad)$/i.test(status);
  if (cleanish && bytes > 640) errs.push(`CLEAN exceeds 640B (${bytes})`);
  if (warnish  && bytes > 800) errs.push(`${status} exceeds 800B (${bytes})`);
  return {ok: errs.length===0, errs, version: version||'—', status: status||'—', bytes};
}

/* ================= renderers ================= */
function renderUniformTile(title, srcUrl, rec, bytes){
  const n = normalize(rec);
  const t = el('div','tile');
  const head = el('div','inline'); head.style.justifyContent='space-between'; head.style.alignItems='center';
  head.appendChild(el('div','', title));
  const pills = el('div'); pills.style.display='flex'; pills.style.gap='8px';
  const statusClass = n.status.match(/clean|ok|green/i)?'ok':n.status.match(/warn|amber|check/i)?'warn':n.status.match(/red|risk|bad/i)?'bad':'neutral';
  pills.appendChild(el('span','chip '+statusClass, n.status || '—'));
  pills.appendChild(el('span','chip neutral', n.version));
  head.appendChild(pills);

  const card = el('div','card');
  const row=(k,v)=>{const r=el('div','row'); r.appendChild(el('div','left',k)); r.appendChild(el('div','right',v||'—')); return r;};
  card.appendChild(row('MODEL',n.model));
  card.appendChild(row('ISSUED',n.issued));
  card.appendChild(row('PRECISION',n.prec));
  card.appendChild(row('POINT',n.point));
  card.appendChild(row('BECAUSE',n.because));
  card.appendChild(row('BUT',n.but));
  card.appendChild(row('SO',n.so));

  const dialRow = el('div','inline'); dialRow.style.gap='8px'; dialRow.style.margin='10px 14px';
  const toTxt = (k,v)=>{
    if (typeof v==='number' && Number.isFinite(v)){
      if (k==='Φ*') { const stars = Math.round(clamp01(v)*5); return `${v.toFixed(3)} (${stars}★)`; }
      return v.toFixed(3);
    }
    return v==null ? '—' : String(v);
  };
  dialRow.appendChild(el('span','chip neutral', `κ — ${toTxt('κ', n.dials.kappa)}`));
  dialRow.appendChild(el('span','chip neutral', `Δhol — ${toTxt('Δhol', n.dials.dhol)}`));
  const phiChip = el('span','chip neutral', `Φ* — ${toTxt('Φ*', n.dials.phi)}`); phiChip.title='Φ* (phi-star): composite coherence (0–1), shown with 0–5★.';
  dialRow.appendChild(phiChip);
  card.appendChild(dialRow);

  const footer = el('div','note', `source: ${srcUrl} · bytes=${bytes}`);
  const btns = el('div','inline'); btns.style.marginTop='8px';
  const copyUrl = el('a','btn secondary','Copy URL'); copyUrl.href='#';
  copyUrl.onclick = (e)=>{e.preventDefault(); navigator.clipboard.writeText(srcUrl);};
  const copyJson = el('a','btn secondary','Copy JSON'); copyJson.href='#';
  copyJson.onclick = (e)=>{e.preventDefault(); navigator.clipboard.writeText(JSON.stringify(rec,null,2));};
  btns.appendChild(copyUrl); btns.appendChild(copyJson);

  t.appendChild(head); t.appendChild(card); t.appendChild(footer); t.appendChild(btns);
  return t;
}

/* ================= featured loaders (cache for import) ================= */
const FEATURED_CACHE = [];  // {title,url,json,bytes,ck,normalized}
async function loadFeaturedOnce(targetId, url, title){
  const grid = document.getElementById(targetId); if (!grid) return;
  const raw = toRaw(url);
  const res = await fetch(raw + '?v=' + Date.now(), {cache:'no-store'});
  if (!res.ok) throw new Error(`fetch failed (${res.status})`);
  const txt = await res.text(); const bytes = byteLen(txt); const j = JSON.parse(txt);
  const ck = check(j, bytes); const n = normalize(j);
  FEATURED_CACHE.push({title, url: raw, json:j, bytes, ck, normalized:n});
  grid.appendChild(renderUniformTile(title, raw, j, bytes));
  if (targetId==='feat1'){ const box = document.getElementById('valUrl'); if (box) box.value = raw; }
}
async function loadFeaturedWithFallback(targetId, primaryUrl, fallbackUrl, title){
  try { await loadFeaturedOnce(targetId, primaryUrl, title); }
  catch { await loadFeaturedOnce(targetId, fallbackUrl, title + ' (fallback)'); }
}

/* ================= local manifest loader (also returns items) ================= */
async function fetchFirst(pathList){
  for (const p of pathList){
    try{
      const res = await fetch(p + '?v=' + Date.now(), {cache:'no-store'});
      if (res.ok) return {path:p, data: await res.json()};
    }catch{}
  }
  return null;
}
async function loadLocal(listOnly=false){
  const target = document.getElementById('local');
  const title  = document.getElementById('localTitle');
  const got = await fetchFirst(['docs/receipts/manifest.json','receipts/manifest.json']);
  const items = [];
  if (!got){ return items; }
  title.textContent = `Local receipts (from ${got.path})`;
  const list = Array.isArray(got.data) ? got.data : (got.data.files || got.data.receipts || got.data.items || []);
  for (const file of list){
    try{
      const url = toRaw(file);
      const res = await fetch(url + (url.includes('?')?'&':'?') + 'v=' + Date.now(), {cache:'no-store'});
      const txt = await res.text(); const bytes = byteLen(txt); const j = JSON.parse(txt);
      const ck = check(j, bytes); const n = normalize(j);
      items.push({title: (url.split('/').slice(-1)[0]||'receipt.json'), url, json:j, bytes, ck, normalized:n});
      if (!listOnly){ target.appendChild(renderUniformTile(items[items.length-1].title, url, j, bytes)); const spacer = el('div'); spacer.style.height='12px'; target.appendChild(spacer); }
    }catch(e){
      if (!listOnly){ const t = el('div','tile'); t.appendChild(el('div','note',`Failed to load ${file}: ${e.message||'error'}`)); target.appendChild(t); }
    }
  }
  return items;
}

/* ================= validator ================= */
let LAST_PASS = null;
document.getElementById('valBtn').addEventListener('click', async (ev)=>{
  ev.preventDefault();
  const box = document.getElementById('valUrl');
  const out = document.getElementById('valOut');
  const why = document.getElementById('whyPass');
  const addBtn = document.getElementById('addToWalletBtn');
  let input = (box.value||'').trim();
  LAST_PASS = null; addBtn.style.display='none'; why.style.display='none';
  if (!input) { out.textContent='Provide a URL or paste a JSON receipt.'; return; }
  try{
    let j, bytes, src='(pasted)';
    if (input.startsWith('{')) { j = JSON.parse(input); bytes = byteLen(JSON.stringify(j)); }
    else {
      const raw = toRaw(input); src = raw;
      const res = await fetch(raw + (raw.includes('?')?'&':'?') + 'v=' + Date.now(), {cache:'no-store'});
      if (!res.ok) throw new Error(`fetch failed (${res.status})`);
      const txt = await res.text(); bytes = byteLen(txt); j = JSON.parse(txt);
    }
    const result = check(j, bytes);
    const cap = STATUS_GREEN(result.status) ? 640 : 800;
    const sigs = j.signals ? Object.entries(j.signals).map(([k,v])=>`${k}=${(typeof v==='number')?Number(v).toFixed(3):v}`).join(', ') : '—';
    out.textContent = result.ok
      ? `✅ PASS\nbytes=${result.bytes} (≤${cap}) · status=${result.status} · version=${result.version}\nSignals: ${sigs}`
      : `❌ FAIL\n- ${result.errs.join('\n- ')}`;
    if (result.ok){
      why.style.display='block';
      LAST_PASS = {src, json:j, bytes:result.bytes, status:result.status, version:result.version};
      addBtn.style.display='inline-block';
    }
  }catch(e){
    out.textContent = `❌ ${e.message || 'fetch/parse failed'}`;
  }
});
document.getElementById('copyTpl').addEventListener('click', (e)=>{
  e.preventDefault();
  navigator.clipboard.writeText(JSON.stringify(SAMPLE_JSON, null, 2));
});

/* ================= wallet (localStorage) ================= */
const WALLET_KEY = 'ol.wallet.v2';      // bump key to avoid old broken state
const WALLET_SEEDED = 'ol.wallet.seeded.v2';

function loadWallet(){ try{ return JSON.parse(localStorage.getItem(WALLET_KEY)) || {packs:{}}; }catch{ return {packs:{}}; } }
function saveWallet(w){ localStorage.setItem(WALLET_KEY, JSON.stringify(w)); }
function listPacks(w){ return Object.keys(w.packs).sort(); }
function ensurePack(w, name){ if(!w.packs[name]) w.packs[name] = {items:[]}; }

const packSel = document.getElementById('packSel');
const newPackBtn = document.getElementById('newPackBtn');
const exportPackBtn = document.getElementById('exportPackBtn');
const clearPackBtn = document.getElementById('clearPackBtn');
const addToWalletBtn = document.getElementById('addToWalletBtn');
const addUrlInput = document.getElementById('addUrl');
const addUrlBtn = document.getElementById('addUrlBtn');
const importFeaturedBtn = document.getElementById('importFeaturedBtn');
const importLocalBtn = document.getElementById('importLocalBtn');
const seedDemoBtn = document.getElementById('seedDemoBtn');
const packStats = document.getElementById('packStats');
const packList = document.getElementById('packList');
const packDash = document.getElementById('packDash');

let W = loadWallet();
function currentPack(){ return packSel.value || ''; }

function renderPackSel(){
  const names = listPacks(W);
  packSel.innerHTML = '';
  if (names.length===0){ ensurePack(W, 'demo'); saveWallet(W); names.push('demo'); }
  names.forEach(n=>{
    const o = document.createElement('option'); o.value = o.textContent = n; packSel.appendChild(o);
  });
}
function computeDashboard(items){
  const n = items.length;
  if (!n){ packDash.innerHTML = '<div class="note">No items yet.</div>'; return; }
  const nums = (f)=>items.map(f).filter(Number.isFinite);
  const avg = (a)=> a.length? (a.reduce((x,y)=>x+y,0)/a.length) : 0;
  const greens = items.filter(x=>STATUS_GREEN(x.status)).length;

  const kList = nums(x=>x.signals?.kappa);
  const dList = nums(x=>x.signals?.dhol);
  const pList = nums(x=>x.signals?.phi_star);
  const breaches = {
    kappa: items.filter(x=>Number.isFinite(x.signals?.kappa) && x.signals.kappa>0.75).length,
    dhol:  items.filter(x=>Number.isFinite(x.signals?.dhol)  && x.signals.dhol>0.35).length,
    phi:   items.filter(x=>Number.isFinite(x.signals?.phi_star) && x.signals.phi_star<0.80).length
  };

  const worst = (key, asc=false)=> items
    .filter(x=>Number.isFinite(x.signals?.[key]))
    .sort((a,b)=> asc ? (a.signals[key]-b.signals[key]) : (b.signals[key]-a.signals[key]))
    .slice(0,3)
    .map(x=>`${x.title||'(item)'} — ${x.signals[key].toFixed(3)}${x.url?` · [open]`:''}`);

  packDash.innerHTML = `
    <div class="note">Items: ${n} · GREEN: ${(greens/n*100).toFixed(0)}% · κ(avg): ${avg(kList).toFixed(3)} · Δhol(avg): ${avg(dList).toFixed(3)} · Φ*(avg): ${avg(pList).toFixed(3)}</div>
    <div class="tile" style="margin-top:8px">
      <div><b>Brake / Split / Go</b></div>
      <ul style="margin:6px 0 0 18px">
        <li>κ > .75 (stress): ${breaches.kappa}/${n}</li>
        <li>Δhol > .35 (drift): ${breaches.dhol}/${n}</li>
        <li>Φ* < .80 (low coherence): ${breaches.phi}/${n}</li>
      </ul>
    </div>
    <div class="tile" style="margin-top:8px">
      <div><b>Top offenders</b></div>
      <div class="note">High κ: ${worst('kappa').join(' | ') || '—'}</div>
      <div class="note">High Δhol: ${worst('dhol').join(' | ') || '—'}</div>
      <div class="note">Low Φ*: ${worst('phi_star', true).join(' | ') || '—'}</div>
    </div>
  `;
}

function renderPack(){
  const name = currentPack();
  ensurePack(W, name);
  const items = W.packs[name].items || [];

  // Stats
  const n = items.length;
  const greens = items.filter(x => STATUS_GREEN(x.status)).length;
  const avg = (arr)=> arr.length ? (arr.reduce((a,b)=>a+(Number.isFinite(b)?b:0),0)/arr.length) : 0;
  const kList = items.map(x=>x.signals?.kappa).filter(Number.isFinite);
  const dList = items.map(x=>x.signals?.dhol).filter(Number.isFinite);
  const pList = items.map(x=>x.signals?.phi_star).filter(Number.isFinite);

  packStats.textContent = n
    ? `Items: ${n} · GREEN: ${(greens/n*100).toFixed(0)}% · κ(avg): ${avg(kList).toFixed(3)} · Δhol(avg): ${avg(dList).toFixed(3)} · Φ*(avg): ${avg(pList).toFixed(3)}`
    : 'No items yet. Import or validate to start.';

  // Dashboard
  computeDashboard(items);

  // List
  packList.innerHTML = '';
  items.forEach((it, idx)=>{
    const tile = el('div','tile');
    const head = el('div','inline'); head.style.justifyContent='space-between'; head.style.alignItems='center';
    head.appendChild(el('div','', it.title || (it.url||'(pasted)')));
    const pills = el('div'); pills.style.display='flex'; pills.style.gap='8px';
    const cls = it.status?.match(/green|clean|ok/i)?'ok':it.status?.match(/amber|warn|check/i)?'warn':it.status?.match(/red|risk|bad/i)?'bad':'neutral';
    pills.appendChild(el('span','chip '+cls, it.status || '—'));
    pills.appendChild(el('span','chip neutral', it.version || '—'));
    if (it.bytes!=null) pills.appendChild(el('span','chip neutral', `bytes ${it.bytes}`));
    head.appendChild(pills);
    tile.appendChild(head);

    const row = el('div','inline'); row.style.gap='8px'; row.style.marginTop='8px';
    const toTxt = (k,v)=>{
      if (typeof v==='number' && Number.isFinite(v)){
        if (k==='Φ*'){ const stars=Math.round(clamp01(v)*5); return `${v.toFixed(3)} (${stars}★)`; }
        return v.toFixed(3);
      }
      return v==null?'—':String(v);
    };
    row.appendChild(el('span','chip neutral', `κ — ${toTxt('κ', it.signals?.kappa)}`));
    row.appendChild(el('span','chip neutral', `Δhol — ${toTxt('Δhol', it.signals?.dhol)}`));
    row.appendChild(el('span','chip neutral', `Φ* — ${toTxt('Φ*', it.signals?.phi_star)}`));
    tile.appendChild(row);

    const btns = el('div','inline'); btns.style.marginTop='8px';
    if (it.url){
      const open = el('a','btn secondary','Open'); open.href=it.url; open.target='_blank'; btns.appendChild(open);
      const copy = el('a','btn secondary','Copy URL'); copy.href='#'; copy.onclick=(e)=>{e.preventDefault(); navigator.clipboard.writeText(it.url);}; btns.appendChild(copy);
    }
    const rm = el('a','btn secondary','Remove'); rm.href='#'; rm.onclick=(e)=>{e.preventDefault(); W.packs[name].items.splice(idx,1); saveWallet(W); renderPack();}; btns.appendChild(rm);
    tile.appendChild(btns);

    packList.appendChild(tile);
  });
}

function addItemToPack(packName, item){
  ensurePack(W, packName);
  W.packs[packName].items.push(item);
  saveWallet(W);
  renderPack();
}

newPackBtn.addEventListener('click',(e)=>{
  e.preventDefault();
  const n = prompt('New pack name:','pack-'+Math.floor(Math.random()*1e3));
  if (!n) return;
  ensurePack(W, n); saveWallet(W); renderPackSel(); packSel.value = n; renderPack();
});
exportPackBtn.addEventListener('click',(e)=>{
  e.preventDefault();
  const name = currentPack(); ensurePack(W,name);
  const data = JSON.stringify(W.packs[name], null, 2);
  navigator.clipboard.writeText(data);
  alert('Pack JSON copied to clipboard.');
});
clearPackBtn.addEventListener('click',(e)=>{
  e.preventDefault();
  const name=currentPack();
  if (!confirm(`Clear all items in pack "${name}"?`)) return;
  W.packs[name].items = []; saveWallet(W); renderPack();
});
packSel.addEventListener('change', ()=> renderPack());

addToWalletBtn.addEventListener('click',(e)=>{
  e.preventDefault();
  if (!LAST_PASS) return;
  const n = normalize(LAST_PASS.json);
  const title = (LAST_PASS.src && LAST_PASS.src.split('/').slice(-1)[0]) || 'pasted';
  const item = {
    title, url: LAST_PASS.src.startsWith('http') ? LAST_PASS.src : null,
    status: LAST_PASS.status, version: LAST_PASS.version, bytes: LAST_PASS.bytes,
    signals: { kappa: n.dials.kappa, dhol: n.dials.dhol, phi_star: n.dials.phi }
  };
  addItemToPack(currentPack(), item);
});
addUrlBtn.addEventListener('click', async (e)=>{
  e.preventDefault();
  const u = addUrlInput.value.trim(); if (!u) return;
  try{
    const raw = toRaw(u);
    const res = await fetch(raw + (raw.includes('?')?'&':'?') + 'v=' + Date.now(), {cache:'no-store'});
    if (!res.ok) throw new Error(`fetch failed (${res.status})`);
    const txt = await res.text(); const bytes = byteLen(txt); const j = JSON.parse(txt);
    const ck = check(j, bytes); const n = normalize(j);
    const title = raw.split('/').slice(-1)[0] || 'receipt.json';
    const item = { title, url: raw, status: ck.status, version: ck.version, bytes: bytes,
                   signals: { kappa: n.dials.kappa, dhol: n.dials.dhol, phi_star: n.dials.phi } };
    addItemToPack(currentPack(), item); addUrlInput.value='';
  }catch(err){ alert('Add failed: ' + (err.message||'unknown')); }
});

/* Importers */
importFeaturedBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  const name = currentPack(); let count=0;
  FEATURED_CACHE.forEach(it=>{
    addItemToPack(name, {
      title: it.title, url: it.url, status: it.ck.status, version: it.ck.version, bytes: it.bytes,
      signals: { kappa: it.normalized.dials.kappa, dhol: it.normalized.dials.dhol, phi_star: it.normalized.dials.phi }
    }); count++;
  });
  if (!count) alert('No featured receipts loaded yet.');
});
importLocalBtn.addEventListener('click', async (e)=>{
  e.preventDefault();
  const name = currentPack();
  const items = await loadLocal(true);
  if (!items.length){ alert('No local manifest receipts found.'); return; }
  items.forEach(it=>{
    addItemToPack(name, {
      title: it.title, url: it.url, status: it.ck.status, version: it.ck.version, bytes: it.bytes,
      signals: { kappa: it.normalized.dials.kappa, dhol: it.normalized.dials.dhol, phi_star: it.normalized.dials.phi }
    });
  });
});
seedDemoBtn.addEventListener('click',(e)=>{
  e.preventDefault();
  localStorage.removeItem(WALLET_SEEDED);
  seedIfNeeded(true);
});

/* ================= boot ================= */
function renderPackSelAndDefault(){
  renderPackSel();
  if (!packSel.value) packSel.value='demo';
  renderPack();
}
function seedIfNeeded(force=false){
  if (!force && localStorage.getItem(WALLET_SEEDED)) return;
  ensurePack(W, 'demo');
  // Always include the in-memory SAMPLE_JSON
  addItemToPack('demo', {
    title:'sample.receipt.json', url:null, status:'clean', version:'OLR/1.5-P', bytes: JSON.stringify(SAMPLE_JSON).length,
    signals:{ kappa:SAMPLE_JSON.signals.kappa, dhol:SAMPLE_JSON.signals.dhol, phi_star:SAMPLE_JSON.signals.phi_star }
  });
  // If featured already fetched, add them too
  FEATURED_CACHE.forEach(it=>{
    addItemToPack('demo', {
      title: it.title, url: it.url, status: it.ck.status, version: it.ck.version, bytes: it.bytes,
      signals: { kappa: it.normalized.dials.kappa, dhol: it.normalized.dials.dhol, phi_star: it.normalized.dials.phi }
    });
  });
  localStorage.setItem(WALLET_SEEDED,'1');
}

async function boot(){
  renderPackSelAndDefault();
  // Load featured (these populate FEATURED_CACHE)
  loadFeaturedWithFallback(
    'feat1',
    'https://raw.githubusercontent.com/terryncew/COLE-Coherence-Layer-Engine-/main/docs/receipt.mini.json',
    'https://raw.githubusercontent.com/terryncew/COLE-Coherence-Layer-Engine-/main/docs/receipt.latest.json',
    'COLE-Coherence-Layer-Engine / receipt'
  );
  loadFeaturedWithFallback(
    'feat2',
    'https://raw.githubusercontent.com/terryncew/open-receipts/main/docs/receipt.latest.json',
    'https://github.com/terryncew/open-receipts/blob/main/docs/receipt.latest.json',
    'open-receipts / receipt.latest.json'
  );
  loadFeaturedWithFallback(
    'feat3',
    'https://raw.githubusercontent.com/terryncew/openline-csm/main/docs/receipt.latest.json',
    'https://github.com/terryncew/openline-csm/blob/main/docs/receipt.latest.json',
    'openline-csm / receipt.latest.json'
  );

  // Load local receipts (render tiles) but also allow later import to wallet
  loadLocal(false);

  // Seed demo (guarantees Wallet isn’t empty on first load)
  seedIfNeeded(false);
}
boot();
</script>
</body>
</html>
