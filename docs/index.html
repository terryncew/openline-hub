<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>OpenLine Hub · Portable Proof for AI</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="dark light">
<style>
  :root{--bg:#0a0c10;--ink:#e7ecf4;--muted:#97a3b6;--line:#1b2230;--tile:#0f141c;--btn:#1e293b;--btnink:#e7ecf4;--btnline:#2a3a55;--chip:#121925;--chipline:#1b2536}
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 -apple-system,system-ui,Segoe UI,Inter,Roboto,Helvetica,Arial}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:980px;margin:0 auto;padding:18px}
  header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:12px}
  header h1{font-size:20px;margin:2px 0 0} .sub{color:var(--muted);font-size:13px}
  .section{margin:18px 0} h2{font-size:16px;margin:0 0 8px}
  .hero,.tile{background:var(--tile);border:1px solid var(--line);border-radius:12px;padding:12px}
  .hero{padding:14px} .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid var(--btnline);background:var(--btn);color:var(--btnink);font-weight:600}
  .tile + .tile{margin-top:12px}
  .card{border:1px solid var(--line);border-radius:10px;margin-top:10px;overflow:hidden}
  .row{display:flex;gap:14px;border-top:1px solid var(--line)} .row:first-child{border-top:0}
  .left{min-width:120px;padding:10px 14px;color:var(--muted);font-weight:600} .right{flex:1;padding:10px 14px}
  .chip{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--chipline);background:var(--chip);padding:6px 10px;border-radius:999px;font-size:12px;line-height:1;height:26px}
  .ok{background:rgba(30,166,114,.15);border-color:rgba(30,166,114,.35)}
  .warn{background:rgba(179,139,16,.15);border-color:rgba(179,139,16,.35)}
  .bad{background:rgba(210,61,61,.15);border-color:rgba(210,61,61,.35)}
  .neutral{opacity:.85} .note{color:var(--muted);font-size:12px;margin:8px 2px}
  input{width:100%;background:var(--tile);border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:10px}
  @media (max-width:560px){ .left{min-width:96px} }
</style>
</head>
<body>
<div class="wrap">

  <header>
    <div>
      <h1>OpenLine Hub</h1>
      <div class="sub">Portable proof · vendor-neutral</div>
    </div>
    <div class="inline">
      <a class="btn" href="exclusive.html">Exclusive offers</a>
      <a class="btn" href="#wallet">Jump to Wallet</a>
    </div>
  </header>

  <div class="section hero">
    <div style="font-size:18px;font-weight:700;margin-bottom:8px">Proof moves; data doesn’t.</div>
    <div class="sub">Viewer + wallet for OLR/1.5-P & 1.4L. This page seeds a demo wallet automatically so you can see it working immediately.</div>
  </div>

  <!-- FEATURED (3 receipts) -->
  <div class="section">
    <h2>Featured receipts</h2>
    <div id="feat1"></div>
    <div id="feat2" style="margin-top:12px"></div>
    <div id="feat3" style="margin-top:12px"></div>
  </div>

  <!-- WALLET -->
  <div class="section" id="wallet">
    <h2>Wallet (local demo pack)</h2>
    <div class="tile">
      <div class="note">LocalStorage only. No server. Auto-seeded from Featured + Local lists below so it never starts empty.</div>

      <div class="inline" style="gap:8px;margin-bottom:8px">
        <select id="packSel"></select>
        <a class="btn" id="reseeder">Demo Reset & Reseed</a>
        <a class="btn" id="exportPackBtn">Copy pack.json</a>
        <a class="btn" id="clearPackBtn">Clear pack</a>
      </div>

      <div class="inline" style="gap:8px;margin-bottom:8px">
        <input id="addUrl" placeholder="Add receipt by URL (raw GitHub best)"/>
        <a class="btn" id="addUrlBtn">Add</a>
      </div>

      <div id="packStats" class="note">—</div>
      <div id="packList"></div>
    </div>
  </div>

  <!-- LOCAL -->
  <div class="section">
    <h2 id="localTitle">Local receipts</h2>
    <div class="note">Reads <code>docs/receipts/manifest.json</code>. Click a tile → Copy URL → Add to Wallet (already auto-seeded).</div>
    <div id="local"></div>
  </div>

  <div class="section">
    <div class="sub">OpenLine · COLE · MIT.</div>
  </div>
</div>

<script>
/* ---------- constants ---------- */
const FEATURED = [
  { title: 'COLE-Coherence-Layer-Engine / receipt.mini.json',
    url: 'https://raw.githubusercontent.com/terryncew/COLE-Coherence-Layer-Engine/main/docs/receipt.mini.json' },
  { title: 'open-receipts / receipt.latest.json',
    url: 'https://raw.githubusercontent.com/terryncew/open-receipts/main/docs/receipt.latest.json' },
  { title: 'openline-csm / receipt.latest.json',
    url: 'https://raw.githubusercontent.com/terryncew/openline-csm/main/docs/receipt.latest.json' },
];
const MANIFEST_PATHS = ['docs/receipts/manifest.json','receipts/manifest.json'];
const WALLET_KEY = 'ol.wallet.v1';
const SEEDED_KEY = 'ol.wallet.seeded.v1';

/* ---------- utils ---------- */
const el=(t,c,txt)=>{const e=document.createElement(t); if(c) e.className=c; if(txt!=null) e.textContent=txt; return e;};
const byteLen = s => new TextEncoder().encode(s).length;
function toRaw(u){ try{
  const url = new URL(u.trim());
  if (url.hostname === 'github.com') {
    const p = url.pathname.split('/').filter(Boolean);
    if (p[2] === 'blob') return `https://raw.githubusercontent.com/${p[0]}/${p[1]}/${p[3]}/${p.slice(4).join('/')}`;
  }
  return u;
}catch{ return u; } }
const STATUS_GREEN = s => /^(green|clean|ok)$/i.test(String(s||''));
const clamp01 = v => Math.max(0, Math.min(1, v));

/* ---------- normalize & check ---------- */
function normalize(r){
  const v = r.version || r.receipt_version || r.receiptVersion || r.sku || '—';
  const status = (r.attrs?.status || r.status || '').toString();
  const model = r.model?.family || r.model?.name || r.model?.id || r.model || '—';
  const issued = r.issued_at || r.issued || r.run?.ts || r.time || r.date || '—';
  const prec = (()=>{ const tr=r.precision?.train_dtype||r.train_dtype||r.precision?.train; const inf=r.precision?.infer_dtype||r.infer_dtype||r.precision?.infer; return (tr||inf)?`${tr||'—'}/${inf||'—'}`:(r.precision||'—');})();
  const claims = r.claims || r;
  const point   = claims.point   ?? '—';
  const because = claims.because ?? '—';
  const but     = claims.but     ?? '—';
  const so      = claims.so      ?? '—';
  const kappa = r.signals?.kappa ?? r.kappa ?? r.κ ?? r.dials?.kappa ?? r.telem?.kappa_eff ?? null;
  const dhol  = r.signals?.dhol  ?? r.signals?.delta_hol ?? r.delta_hol ?? r.Δhol ?? r.dials?.delta_hol ?? r.telem?.delta_hol ?? null;
  const phi   = r.signals?.phi_star ?? r.phi_star ?? r.dials?.phi_star ?? null;
  return {version:v,status,model,issued,prec,point,because,but,so,dials:{kappa,dhol,phi}};
}
function check(r, bytes){
  const errs=[], version=r.version||r.receipt_version||r.receiptVersion, status=(r.attrs?.status||r.status||'').toLowerCase();
  if(!version) errs.push('missing receipt_version/version');
  if(!status)  errs.push('missing attrs.status/status');
  const clean = /^(clean|coherent|ok|green)$/.test(status), warnish=/^(amber|warn|check|red|risk|bad)$/.test(status);
  if (clean && bytes>640) errs.push(`CLEAN exceeds 640B (${bytes})`);
  if (warnish && bytes>800) errs.push(`${status} exceeds 800B (${bytes})`);
  return {ok:errs.length===0, errs, version:version||'—', status:status||'—', bytes};
}

/* ---------- render ---------- */
function renderUniformTile(title, srcUrl, rec, bytes){
  const n = normalize(rec);
  const t = el('div','tile');
  const head = el('div','inline'); head.style.justifyContent='space-between'; head.style.alignItems='center';
  head.appendChild(el('div','', title));
  const pills = el('div'); pills.style.display='flex'; pills.style.gap='8px';
  const cls = n.status.match(/clean|ok|green/i)?'ok':n.status.match(/warn|amber|check/i)?'warn':n.status.match(/red|risk|bad/i)?'bad':'neutral';
  pills.appendChild(el('span','chip '+cls, n.status || '—'));
  pills.appendChild(el('span','chip neutral', n.version));
  head.appendChild(pills);

  const card = el('div','card');
  const row=(k,v)=>{const r=el('div','row'); r.appendChild(el('div','left',k)); r.appendChild(el('div','right',v||'—')); return r;};
  card.appendChild(row('MODEL',n.model));
  card.appendChild(row('ISSUED',n.issued));
  card.appendChild(row('PRECISION',n.prec));
  card.appendChild(row('POINT',n.point));
  card.appendChild(row('BECAUSE',n.because));
  card.appendChild(row('BUT',n.but));
  card.appendChild(row('SO',n.so));
  const dialRow = el('div','inline'); dialRow.style.gap='8px'; dialRow.style.margin='10px 14px';
  const toTxt=(k,v)=> typeof v==='number'&&Number.isFinite(v)?(k==='Φ*'?`${v.toFixed(3)} (${Math.round(clamp01(v)*5)}★)`:v.toFixed(3)):(v==null?'—':String(v));
  dialRow.appendChild(el('span','chip neutral', `κ — ${toTxt('κ', n.dials.kappa)}`));
  dialRow.appendChild(el('span','chip neutral', `Δhol — ${toTxt('Δhol', n.dials.dhol)}`));
  dialRow.appendChild(el('span','chip neutral', `Φ* — ${toTxt('Φ*', n.dials.phi)}`));
  card.appendChild(dialRow);

  const footer = el('div','note', `source: ${srcUrl} · bytes=${bytes}`);
  const btns = el('div','inline'); btns.style.marginTop='8px';
  const copyUrl = el('a','btn','Copy URL'); copyUrl.href='#'; copyUrl.onclick=(e)=>{e.preventDefault(); navigator.clipboard.writeText(srcUrl);};
  const copyJson = el('a','btn','Copy JSON'); copyJson.href='#'; copyJson.onclick=(e)=>{e.preventDefault(); navigator.clipboard.writeText(JSON.stringify(rec,null,2));};
  btns.appendChild(copyUrl); btns.appendChild(copyJson);

  t.appendChild(head); t.appendChild(card); t.appendChild(footer); t.appendChild(btns);
  return t;
}

/* ---------- featured & local loaders ---------- */
async function fetchJsonRaw(u){
  const raw = toRaw(u);
  const res = await fetch(raw + (raw.includes('?')?'&':'?') + 'v=' + Date.now(), {cache:'no-store'});
  if (!res.ok) throw new Error(`fetch failed (${res.status})`);
  const txt = await res.text(); return {json: JSON.parse(txt), bytes: byteLen(txt), url: raw};
}

async function loadFeatured(){
  const targets = ['feat1','feat2','feat3'];
  const out = [];
  for (let i=0;i<FEATURED.length;i++){
    try{
      const r = await fetchJsonRaw(FEATURED[i].url);
      document.getElementById(targets[i]).appendChild(
        renderUniformTile(FEATURED[i].title, r.url, r.json, r.bytes)
      );
      out.push(r.url);
    }catch(e){
      document.getElementById(targets[i]).textContent = 'Failed to load featured.';
    }
  }
  return out;
}

async function fetchFirst(paths){
  for (const p of paths){
    try{ const res = await fetch(p + '?v=' + Date.now(), {cache:'no-store'}); if(res.ok) return {path:p, data: await res.json()}; }catch{}
  }
  return null;
}
async function loadLocal(){
  const target = document.getElementById('local'); const title = document.getElementById('localTitle');
  const got = await fetchFirst(MANIFEST_PATHS); if(!got){ title.textContent='Local receipts (no manifest found)'; return []; }
  title.textContent = `Local receipts (from ${got.path})`;
  const list = Array.isArray(got.data) ? got.data : (got.data.files || got.data.receipts || got.data.items || []);
  const urls = [];
  for (const file of list){
    try{
      const r = await fetchJsonRaw(file);
      target.appendChild(renderUniformTile(file.split('/').slice(-1)[0], r.url, r.json, r.bytes));
      const spacer = document.createElement('div'); spacer.style.height='12px'; target.appendChild(spacer);
      urls.push(r.url);
    }catch(e){
      const t = el('div','tile'); t.appendChild(el('div','note',`Failed to load ${file}`)); target.appendChild(t);
    }
  }
  return urls;
}

/* ---------- wallet ---------- */
function loadWallet(){ try{ return JSON.parse(localStorage.getItem(WALLET_KEY)) || {packs:{}}; }catch{ return {packs:{}}; } }
function saveWallet(w){ localStorage.setItem(WALLET_KEY, JSON.stringify(w)); }
function ensurePack(w, name){ if(!w.packs[name]) w.packs[name]={items:[]}; }
function listPacks(w){ return Object.keys(w.packs).sort(); }
function currentPack(){ return packSel.value || ''; }

const packSel = document.getElementById('packSel');
const exportPackBtn = document.getElementById('exportPackBtn');
const clearPackBtn = document.getElementById('clearPackBtn');
const reseederBtn = document.getElementById('reseeder');
const addUrlInput = document.getElementById('addUrl');
const addUrlBtn = document.getElementById('addUrlBtn');
const packStats = document.getElementById('packStats');
const packList = document.getElementById('packList');

let W = loadWallet();
function renderPackSel(){
  const names = listPacks(W); packSel.innerHTML='';
  if(names.length===0){ ensurePack(W,'demo'); saveWallet(W); names.push('demo'); }
  names.forEach(n=>{ const o=document.createElement('option'); o.value=o.textContent=n; packSel.appendChild(o); });
  packSel.value = 'demo';
}
function renderPack(){
  const name = currentPack(); ensurePack(W,name);
  const items = W.packs[name].items || [];
  const greens = items.filter(x=>STATUS_GREEN(x.status)).length;
  const avg = arr => arr.length ? (arr.reduce((a,b)=>a+(Number.isFinite(b)?b:0),0)/arr.length) : 0;
  const kList = items.map(x=>x.signals?.kappa).filter(Number.isFinite);
  const dList = items.map(x=>x.signals?.dhol).filter(Number.isFinite);
  const pList = items.map(x=>x.signals?.phi_star).filter(Number.isFinite);
  packStats.textContent = items.length
    ? `Items: ${items.length} · GREEN: ${(greens/items.length*100|0)}% · κ(avg): ${avg(kList).toFixed(3)} · Δhol(avg): ${avg(dList).toFixed(3)} · Φ*(avg): ${avg(pList).toFixed(3)}`
    : 'No items yet. Auto-seeding… or add a URL.';
  packList.innerHTML='';
  items.forEach((it,idx)=>{
    const tile = el('div','tile');
    const head = el('div','inline'); head.style.justifyContent='space-between'; head.style.alignItems='center';
    head.appendChild(el('div','', it.title || it.url || '(pasted)'));
    const pills = el('div'); pills.style.display='flex'; pills.style.gap='8px';
    const cls = it.status.match(/green|clean|ok/i)?'ok':it.status.match(/amber|warn|check/i)?'warn':it.status.match(/red|risk|bad/i)?'bad':'neutral';
    pills.appendChild(el('span','chip '+cls, it.status || '—'));
    pills.appendChild(el('span','chip neutral', it.version || '—'));
    pills.appendChild(el('span','chip neutral', `bytes ${it.bytes ?? '—'}`));
    head.appendChild(pills);
    tile.appendChild(head);

    const row = el('div','inline'); row.style.gap='8px'; row.style.marginTop='8px';
    const toTxt=(k,v)=> typeof v==='number'&&Number.isFinite(v)?(k==='Φ*'?`${v.toFixed(3)} (${Math.round(clamp01(v)*5)}★)`:v.toFixed(3)):(v==null?'—':String(v));
    row.appendChild(el('span','chip neutral', `κ — ${toTxt('κ', it.signals?.kappa)}`));
    row.appendChild(el('span','chip neutral', `Δhol — ${toTxt('Δhol', it.signals?.dhol)}`));
    row.appendChild(el('span','chip neutral', `Φ* — ${toTxt('Φ*', it.signals?.phi_star)}`));
    tile.appendChild(row);

    const btns = el('div','inline'); btns.style.marginTop='8px';
    if (it.url){ const open=el('a','btn','Open'); open.href=it.url; open.target='_blank'; btns.appendChild(open);
      const copy=el('a','btn','Copy URL'); copy.href='#'; copy.onclick=(e)=>{e.preventDefault(); navigator.clipboard.writeText(it.url);}; btns.appendChild(copy); }
    const rm=el('a','btn','Remove'); rm.href='#'; rm.onclick=(e)=>{e.preventDefault(); W.packs[name].items.splice(idx,1); saveWallet(W); renderPack();}; btns.appendChild(rm);
    tile.appendChild(btns);
    packList.appendChild(tile);
  });
}
function addItemToPack(packName, item){
  ensurePack(W, packName);
  // de-dupe by url+bytes
  const exists = W.packs[packName].items.some(x => x.url===item.url && x.bytes===item.bytes);
  if (!exists){ W.packs[packName].items.push(item); saveWallet(W); }
}
async function addUrlToPack(packName, url){
  const r = await fetchJsonRaw(url); const ck = check(r.json, r.bytes); const n = normalize(r.json);
  const title = r.url.split('/').slice(-1)[0] || 'receipt.json';
  addItemToPack(packName, { title, url:r.url, status:ck.status, version:ck.version, bytes:r.bytes,
                            signals:{kappa:n.dials.kappa,dhol:n.dials.dhol,phi_star:n.dials.phi} });
}

/* ---------- seeding ---------- */
async function seedDemo(urls){
  const seeded = localStorage.getItem(SEEDED_KEY)==='1';
  if (seeded && (W.packs['demo']?.items?.length||0)>0) return;
  ensurePack(W,'demo'); saveWallet(W);
  for (const u of urls){ try{ await addUrlToPack('demo', u); }catch{} }
  localStorage.setItem(SEEDED_KEY,'1');
}
async function boot(){
  renderPackSel(); renderPack();
  const f = await loadFeatured();
  const l = await loadLocal();
  await seedDemo([...f, ...l]);
  renderPack();
}
packSel.addEventListener('change', renderPack);
exportPackBtn.addEventListener('click',()=>{ const name=currentPack(); ensurePack(W,name); navigator.clipboard.writeText(JSON.stringify(W.packs[name],null,2)); alert('Pack JSON copied.'); });
clearPackBtn.addEventListener('click',()=>{ const name=currentPack(); if(!confirm(`Clear "${name}"?`))return; W.packs[name].items=[]; saveWallet(W); renderPack(); });
reseederBtn.addEventListener('click', async ()=>{ if(!confirm('Reset & reseed demo wallet?')) return; localStorage.removeItem(SEEDED_KEY); W.packs['demo']={items:[]}; saveWallet(W); await boot(); });
addUrlBtn.addEventListener('click', async (e)=>{ e.preventDefault(); const u=addUrlInput.value.trim(); if(!u) return; try{ await addUrlToPack(currentPack()||'demo', u); addUrlInput.value=''; renderPack(); }catch(err){ alert('Add failed'); } });

boot();
</script>
</body>
</html>
